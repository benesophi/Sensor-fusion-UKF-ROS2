#!/usr/bin/env python3
# ===================================================================================
# Script:       plot_results.py
# Author:       Sophia de Souza Nobre Benevides
# Last Update:  15-09-2025
# Description:  Reads the CSV data file generated by the UKF node and uses
#               Matplotlib to plot the resulting trajectories and quaternion data
#               for analysis.
# ===================================================================================

import pandas as pd
import matplotlib.pyplot as plt

def main():
    """
    Main function to load data and generate plots.
    """
    data = pd.read_csv('/home/lasi/kf_data.csv', header=0, index_col=False)
    plt.rcParams["text.usetex"] = True

    # Normalize timestamps to get elapsed time in seconds for the x-axis.
    start_time = data['timestamp'].min()
    data['elapsed_time'] = data['timestamp'] - start_time

    # --- 1. XY Trajectory Plot ---
    plt.figure(figsize=(10, 8))

    # Plot the full trajectories for UKF (solid), GNSS (dashed), and IMU (dash-dot).
    plt.plot(data['est_x'].to_numpy(), data['est_y'].to_numpy(), label='UKF Path (red)', color='red', linestyle='-', alpha=1)
    plt.plot(data['meas_x'].to_numpy(), data['meas_y'].to_numpy(), label='GNSS Path (blue)', color='blue', linestyle='--', alpha=1)
    plt.plot(data['imu_x'].to_numpy(), data['imu_y'].to_numpy(), label='IMU Path (green)', color='green', linestyle='-.', alpha=1)

    plt.scatter(data['est_x'].iloc[0], data['est_y'].iloc[0], color='red', marker='o', s=150, label="Start UKF", edgecolors="black", linewidth=1.5)
    plt.scatter(data['meas_x'].iloc[0], data['meas_y'].iloc[0], color='blue', marker='s', s=150, label="Start GNSS", edgecolors="black", linewidth=1.5)
    plt.scatter(data['imu_x'].iloc[0], data['imu_y'].iloc[0], color='green', marker='*', s=150, label="Start IMU", edgecolors="black", linewidth=1.5)

    plt.title('Displacement in the XY Plane')
    plt.xlabel('X Position (m)')
    plt.ylabel('Y Position (m)')
    plt.legend()
    plt.grid(True)
    plt.axis('equal')
    plt.tight_layout()
    plt.show()

    # --- 2. Quaternion Components vs. Time comparing the UKF estimate with the raw GNSS measurement. ---
    plt.figure(figsize=(12, 8))

    # Subplot 1: qx
    plt.subplot(4, 1, 1)
    plt.plot(data['elapsed_time'].to_numpy(), data['est_qx'].to_numpy(), label='Estimated Qx (UKF)', color='red', linestyle='-')
    plt.plot(data['elapsed_time'].to_numpy(), data['meas_qx'].to_numpy(), label='Measured Qx', color='blue', linestyle='--')
    plt.title('Qx Comparison',fontsize=20)
    plt.xlabel('Elapsed Time (s)', fontsize=18)
    plt.ylabel('Value',fontsize=18)
    plt.tick_params(axis='both', labelsize=16)
    plt.legend()
    plt.grid(True)

    # Subplot 2: qy
    plt.subplot(4, 1, 2)
    plt.plot(data['elapsed_time'].to_numpy(), data['est_qy'].to_numpy(), label='Estimated Qy (UKF)', color='red', linestyle='-')
    plt.plot(data['elapsed_time'].to_numpy(), data['meas_qy'].to_numpy(), label='Measured Qy', color='blue', linestyle='--')
    plt.title('Qy Comparison', fontsize=20)
    plt.xlabel('Elapsed Time (s)', fontsize=18)
    plt.ylabel('Value',fontsize=18)
    plt.tick_params(axis='both', labelsize=16)
    plt.legend()
    plt.grid(True)

    # Subplot 3: qz
    plt.subplot(4, 1, 3)
    plt.plot(data['elapsed_time'].to_numpy(), data['est_qz'].to_numpy(), label='Estimated Qz (UKF)', color='red', linestyle='-')
    plt.plot(data['elapsed_time'].to_numpy(), data['meas_qz'].to_numpy(), label='Measured Qz', color='blue', linestyle='--')
    plt.title('Qz Comparison', fontsize=20)
    plt.xlabel('Elapsed Time (s)', fontsize=18)
    plt.ylabel('Value', fontsize=18)
    plt.tick_params(axis='both', labelsize=16)
    plt.legend()
    plt.grid(True)
    
    # Subplot 4: qw
    plt.subplot(4, 1, 4)
    plt.plot(data['elapsed_time'].to_numpy(), data['est_qw'].to_numpy(), label='Estimated Qw (UKF)', color='red', linestyle='-')
    plt.plot(data['elapsed_time'].to_numpy(), data['meas_qw'].to_numpy(), label='Measured Qw', color='blue', linestyle='--')
    plt.title('Qw Comparison', fontsize=20)
    plt.xlabel('Elapsed Time (s)', fontsize=18)
    plt.ylabel('Value', fontsize=18)
    plt.tick_params(axis='both', labelsize=16)
    plt.legend()
    plt.grid(True)

    plt.tight_layout()
    plt.show()

if __name__ == '__main__':
    main()